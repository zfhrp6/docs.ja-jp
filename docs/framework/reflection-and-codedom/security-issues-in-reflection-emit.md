---
title: リフレクション出力のセキュリティ関連事項
ms.date: 03/30/2017
helpviewer_keywords:
- partially trusted code
- emitting dynamic assemblies, security
- reflection emit, security
- reflection emit, partial trust scenarios
- partial trust,emitting dynamic methods
- anonymously hosted dynamic methods [.NET Framework]
- emitting dynamic assemblies,partial trust scenarios
- dynamic assemblies, security
ms.assetid: 0f8bf8fa-b993-478f-87ab-1a1a7976d298
author: rpetrusha
ms.author: ronpet
ms.openlocfilehash: 57db77b64ddcbe282fed035b52bb122901383ca4
ms.sourcegitcommit: 3d5d33f384eeba41b2dff79d096f47ccc8d8f03d
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 05/04/2018
---
# <a name="security-issues-in-reflection-emit"></a><span data-ttu-id="70bba-102">リフレクション出力のセキュリティ関連事項</span><span class="sxs-lookup"><span data-stu-id="70bba-102">Security Issues in Reflection Emit</span></span>
<span data-ttu-id="70bba-103">[!INCLUDE[dnprdnshort](../../../includes/dnprdnshort-md.md)] には、Microsoft Intermediate Language (MSIL) を出力する方法が 3 種類ありますが、それぞれに固有のセキュリティ問題があります。</span><span class="sxs-lookup"><span data-stu-id="70bba-103">The [!INCLUDE[dnprdnshort](../../../includes/dnprdnshort-md.md)] provides three ways to emit Microsoft intermediate language (MSIL), each with its own security issues:</span></span>  
  
-   [<span data-ttu-id="70bba-104">動的アセンブリ</span><span class="sxs-lookup"><span data-stu-id="70bba-104">Dynamic assemblies</span></span>](#Dynamic_Assemblies)  
  
-   [<span data-ttu-id="70bba-105">匿名でホストされる動的メソッド</span><span class="sxs-lookup"><span data-stu-id="70bba-105">Anonymously hosted dynamic methods</span></span>](#Anonymously_Hosted_Dynamic_Methods)  
  
-   [<span data-ttu-id="70bba-106">既存のアセンブリに関連付けられている動的メソッド</span><span class="sxs-lookup"><span data-stu-id="70bba-106">Dynamic methods associated with existing assemblies</span></span>](#Dynamic_Methods_Associated_with_Existing_Assemblies)  
  
 <span data-ttu-id="70bba-107">動的コードの生成方法に関係なく、生成済みコードを実行するには、生成済みコードで使用される型やメソッドに必要なすべてのアクセス許可が必要です。</span><span class="sxs-lookup"><span data-stu-id="70bba-107">Regardless of the way you generate dynamic code, executing the generated code requires all the permissions that are required by the types and methods the generated code uses.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="70bba-108">コードでのリフレクションとコードの出力に必要なアクセス許可は、[!INCLUDE[dnprdnshort](../../../includes/dnprdnshort-md.md)] のリリースによって異なります。</span><span class="sxs-lookup"><span data-stu-id="70bba-108">The permissions that are required for reflecting on code and emitting code have changed with succeeding releases of the [!INCLUDE[dnprdnshort](../../../includes/dnprdnshort-md.md)].</span></span> <span data-ttu-id="70bba-109">このトピックの「[バージョン情報](#Version_Information)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="70bba-109">See [Version Information](#Version_Information), later in this topic.</span></span>  
  
<a name="Dynamic_Assemblies"></a>   
## <a name="dynamic-assemblies"></a><span data-ttu-id="70bba-110">動的アセンブリ</span><span class="sxs-lookup"><span data-stu-id="70bba-110">Dynamic Assemblies</span></span>  
 <span data-ttu-id="70bba-111">動的アセンブリを作成するには、<xref:System.AppDomain.DefineDynamicAssembly%2A?displayProperty=nameWithType> メソッドのオーバーロードを使用します。</span><span class="sxs-lookup"><span data-stu-id="70bba-111">Dynamic assemblies are created by using overloads of the <xref:System.AppDomain.DefineDynamicAssembly%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="70bba-112">コンピューター全体のセキュリティ ポリシーが削除されたため、このメソッドのほとんどのオーバーロードは [!INCLUDE[net_v40_long](../../../includes/net-v40-long-md.md)] では使用されていません (非推奨)。</span><span class="sxs-lookup"><span data-stu-id="70bba-112">Most overloads of this method are deprecated in the [!INCLUDE[net_v40_long](../../../includes/net-v40-long-md.md)], because of the elimination of machine-wide security policy.</span></span> <span data-ttu-id="70bba-113">(「[セキュリティの変更](../../../docs/framework/security/security-changes.md)」をご覧ください。)残りのオーバーロードは、信頼レベルに関係なく、任意のコードによって実行できます。</span><span class="sxs-lookup"><span data-stu-id="70bba-113">(See [Security Changes](../../../docs/framework/security/security-changes.md).) The remaining overloads can be executed by any code, regardless of trust level.</span></span> <span data-ttu-id="70bba-114">これらのオーバーロードは 2 つのグループに分けられます。1 つは、動的アセンブリの作成時に適用する属性の一覧を指定するグループで、もう 1 つは属性の一覧を指定しないグループです。</span><span class="sxs-lookup"><span data-stu-id="70bba-114">These overloads fall into two groups: those that specify a list of attributes to apply to the dynamic assembly when it is created, and those that do not.</span></span> <span data-ttu-id="70bba-115">アセンブリの透過性モデルを指定しない場合は、アセンブリの作成時に <xref:System.Security.SecurityRulesAttribute> 属性を適用することによって、出力アセンブリから透過性モデルが継承されます。</span><span class="sxs-lookup"><span data-stu-id="70bba-115">If you do not specify the transparency model for the assembly, by applying the <xref:System.Security.SecurityRulesAttribute> attribute when you create it, the transparency model is inherited from the emitting assembly.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="70bba-116"><xref:System.Reflection.Emit.AssemblyBuilder.SetCustomAttribute%2A> メソッドを使用すると、動的アセンブリの作成後に適用する属性は、そのアセンブリがディスクに保存され、メモリに再び読み込まれるまでは有効になりません。</span><span class="sxs-lookup"><span data-stu-id="70bba-116">Attributes that you apply to the dynamic assembly after it is created, by using the <xref:System.Reflection.Emit.AssemblyBuilder.SetCustomAttribute%2A> method, do not take effect until the assembly has been saved to disk and loaded into memory again.</span></span>  
  
 <span data-ttu-id="70bba-117">動的アセンブリのコードからは、参照できる型と他のアセンブリのメンバーのみにアクセスできます。</span><span class="sxs-lookup"><span data-stu-id="70bba-117">Code in a dynamic assembly can access visible types and members in other assemblies.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="70bba-118">動的アセンブリでは、動的メソッドが非パブリックな型とメンバーにアクセスすることを許可する <xref:System.Security.Permissions.ReflectionPermissionFlag.MemberAccess?displayProperty=nameWithType> フラグと <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> フラグが使用されません。</span><span class="sxs-lookup"><span data-stu-id="70bba-118">Dynamic assemblies do not use the <xref:System.Security.Permissions.ReflectionPermissionFlag.MemberAccess?displayProperty=nameWithType> and <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> flags that allow dynamic methods to access nonpublic types and members.</span></span>  
  
 <span data-ttu-id="70bba-119">一時動的アセンブリはメモリ内に作成され、ディスクに保存されることがないため、ファイルへのアクセス許可は不要です。</span><span class="sxs-lookup"><span data-stu-id="70bba-119">Transient dynamic assemblies are created in memory and never saved to disk, so they require no file access permissions.</span></span> <span data-ttu-id="70bba-120">動的アセンブリをディスクに保存するには、<xref:System.Security.Permissions.FileIOPermission> に適切なフラグを指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="70bba-120">Saving a dynamic assembly to disk requires <xref:System.Security.Permissions.FileIOPermission> with the appropriate flags.</span></span>  
  
### <a name="generating-dynamic-assemblies-from-partially-trusted-code"></a><span data-ttu-id="70bba-121">部分信頼コードからの動的アセンブリの生成</span><span class="sxs-lookup"><span data-stu-id="70bba-121">Generating Dynamic Assemblies from Partially Trusted Code</span></span>  
 <span data-ttu-id="70bba-122">インターネット アクセス許可が設定されたアセンブリで一時動的アセンブリを生成し、そのコードを実行するための条件を考えてみましょう。</span><span class="sxs-lookup"><span data-stu-id="70bba-122">Consider the conditions in which an assembly with Internet permissions can generate a transient dynamic assembly and execute its code:</span></span>  
  
-   <span data-ttu-id="70bba-123">動的アセンブリで使用されるのが、パブリック型と他のアセンブリのメンバーのみである。</span><span class="sxs-lookup"><span data-stu-id="70bba-123">The dynamic assembly uses only public types and members of other assemblies.</span></span>  
  
-   <span data-ttu-id="70bba-124">その型およびメンバーで必要なアクセス許可が、部分信頼のアセンブリの許可セットに含まれている。</span><span class="sxs-lookup"><span data-stu-id="70bba-124">The permissions demanded by those types and members are included in the grant set of the partially trusted assembly.</span></span>  
  
-   <span data-ttu-id="70bba-125">アセンブリがディスクに保存されていない。</span><span class="sxs-lookup"><span data-stu-id="70bba-125">The assembly is not saved to disk.</span></span>  
  
-   <span data-ttu-id="70bba-126">デバッグ シンボルが生成されていない。</span><span class="sxs-lookup"><span data-stu-id="70bba-126">Debug symbols are not generated.</span></span> <span data-ttu-id="70bba-127">(`Internet` および `LocalIntranet` のアクセス許可セットに必要なアクセス許可が指定されていない)</span><span class="sxs-lookup"><span data-stu-id="70bba-127">(`Internet` and `LocalIntranet` permission sets do not include the necessary permissions.)</span></span>  
  
<a name="Anonymously_Hosted_Dynamic_Methods"></a>   
## <a name="anonymously-hosted-dynamic-methods"></a><span data-ttu-id="70bba-128">匿名でホストされる動的メソッド</span><span class="sxs-lookup"><span data-stu-id="70bba-128">Anonymously Hosted Dynamic Methods</span></span>  
 <span data-ttu-id="70bba-129">関連付けられる型やモジュールを指定しない 2 つの <xref:System.Reflection.Emit.DynamicMethod> コンストラクター (<xref:System.Reflection.Emit.DynamicMethod.%23ctor%28System.String%2CSystem.Type%2CSystem.Type%5B%5D%29> および <xref:System.Reflection.Emit.DynamicMethod.%23ctor%28System.String%2CSystem.Type%2CSystem.Type%5B%5D%2CSystem.Boolean%29>) を使用して、匿名でホストされる動的メソッドを作成します。</span><span class="sxs-lookup"><span data-stu-id="70bba-129">Anonymously hosted dynamic methods are created by using the two <xref:System.Reflection.Emit.DynamicMethod> constructors that do not specify an associated type or module, <xref:System.Reflection.Emit.DynamicMethod.%23ctor%28System.String%2CSystem.Type%2CSystem.Type%5B%5D%29> and <xref:System.Reflection.Emit.DynamicMethod.%23ctor%28System.String%2CSystem.Type%2CSystem.Type%5B%5D%2CSystem.Boolean%29>.</span></span> <span data-ttu-id="70bba-130">このコンストラクターにより、システムで指定された完全に信頼される透過的セキュリティ アセンブリに動的メソッドが置かれます。</span><span class="sxs-lookup"><span data-stu-id="70bba-130">These constructors place the dynamic methods in a system-provided, fully trusted, security-transparent assembly.</span></span> <span data-ttu-id="70bba-131">このコンストラクターの使用や動的メソッドのコード出力のために、特別なアクセス許可は必要ありません。</span><span class="sxs-lookup"><span data-stu-id="70bba-131">No permissions are required to use these constructors or to emit code for the dynamic methods.</span></span>  
  
 <span data-ttu-id="70bba-132">ただし、匿名でホストされる動的メソッドが作成されるとき、コール スタックがキャプチャされます。</span><span class="sxs-lookup"><span data-stu-id="70bba-132">Instead, when an anonymously hosted dynamic method is created, the call stack is captured.</span></span> <span data-ttu-id="70bba-133">メソッドの作成時に、キャプチャされたコール スタックに対してセキュリティ要求がなされます。</span><span class="sxs-lookup"><span data-stu-id="70bba-133">When the method is constructed, security demands are made against the captured call stack.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="70bba-134">概念的には、メソッドの作成中に要求がなされます。</span><span class="sxs-lookup"><span data-stu-id="70bba-134">Conceptually, demands are made during the construction of the method.</span></span> <span data-ttu-id="70bba-135">つまり、MSIL 命令が生成されるたびに要求を実行できます。</span><span class="sxs-lookup"><span data-stu-id="70bba-135">That is, demands could be made as each MSIL instruction is emitted.</span></span> <span data-ttu-id="70bba-136">現在の実装では、<xref:System.Reflection.Emit.DynamicMethod.CreateDelegate%2A?displayProperty=nameWithType> メソッドが呼び出されたとき (<xref:System.Reflection.Emit.DynamicMethod.CreateDelegate%2A> を呼び出さずにこのメソッドが呼び出される場合)、または Just-In-Time (JIT) コンパイラが呼び出されたときに、すべての要求がなされます。</span><span class="sxs-lookup"><span data-stu-id="70bba-136">In the current implementation, all demands are made when the <xref:System.Reflection.Emit.DynamicMethod.CreateDelegate%2A?displayProperty=nameWithType> method is called or when the just-in-time (JIT) compiler is invoked, if the method is invoked without calling <xref:System.Reflection.Emit.DynamicMethod.CreateDelegate%2A>.</span></span>  
  
 <span data-ttu-id="70bba-137">アプリケーション ドメインで許可されている場合、匿名でホストされる動的メソッドでは、JIT の参照範囲チェックを省略できますが、制限があります。匿名でホストされる動的メソッドによりアクセスされる非パブリックの型とメンバーがアセンブリに含まれ、そのアセンブリの許可セットが、出力元のコール スタックの許可セットに等しいか、または、そのサブセットであることが必要です。</span><span class="sxs-lookup"><span data-stu-id="70bba-137">If the application domain permits it, anonymously hosted dynamic methods can skip JIT visibility checks, subject to the following restriction: The nonpublic types and members accessed by an anonymously hosted dynamic method must be in assemblies whose grant sets are equal to, or subsets of, the grant set of the emitting call stack.</span></span> <span data-ttu-id="70bba-138">アプリケーション ドメインで <xref:System.Security.Permissions.ReflectionPermission> に <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> フラグが指定されている場合は、この制限付き機能を使って JIT 参照範囲チェックを省略できます。</span><span class="sxs-lookup"><span data-stu-id="70bba-138">This restricted ability to skip JIT visibility checks is enabled if the application domain grants <xref:System.Security.Permissions.ReflectionPermission> with the <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> flag.</span></span>  
  
-   <span data-ttu-id="70bba-139">メソッドでパブリックな型とメンバーのみを使用する場合は、作成中にアクセス許可は不要です。</span><span class="sxs-lookup"><span data-stu-id="70bba-139">If your method uses only public types and members, no permissions are required during construction.</span></span>  
  
-   <span data-ttu-id="70bba-140">JIT 参照範囲チェックを省略するように指定した場合、メソッドの作成時になされる要求には <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> フラグが指定された <xref:System.Security.Permissions.ReflectionPermission> と、アクセスされる非パブリック メンバーを含むアセンブリの許可セットが含まれます。</span><span class="sxs-lookup"><span data-stu-id="70bba-140">If you specify that JIT visibility checks should be skipped, the demand that is made when the method is constructed includes <xref:System.Security.Permissions.ReflectionPermission> with the <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> flag and the grant set of the assembly that contains the nonpublic member that is being accessed.</span></span>  
  
 <span data-ttu-id="70bba-141">非パブリック メンバーの許可セットが考慮されるため、<xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> によって許可された部分信頼コードでは、信頼されるアセンブリの非パブリック メンバーを実行しても特権を昇格することができません。</span><span class="sxs-lookup"><span data-stu-id="70bba-141">Because the grant set of the nonpublic member is taken into consideration, partially trusted code that has been granted <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> cannot elevate its privileges by executing nonpublic members of trusted assemblies.</span></span>  
  
 <span data-ttu-id="70bba-142">他の出力済みコードと同じように、動的メソッドを実行するには、動的メソッドで使用されるメソッドで必要なアクセス許可がすべて必要になります。</span><span class="sxs-lookup"><span data-stu-id="70bba-142">As with any other emitted code, executing the dynamic method requires whatever permissions are demanded by the methods the dynamic method uses.</span></span>  
  
 <span data-ttu-id="70bba-143">匿名でホストされる動的メソッドをホストするシステム アセンブリでは、<xref:System.Security.SecurityRuleSet.Level1?displayProperty=nameWithType> 透過性モデルを使用します。これは、[!INCLUDE[net_v40_short](../../../includes/net-v40-short-md.md)] より前の .NET Framework で使用されていた透過性モデルです。</span><span class="sxs-lookup"><span data-stu-id="70bba-143">The system assembly that hosts anonymously-hosted dynamic methods uses the <xref:System.Security.SecurityRuleSet.Level1?displayProperty=nameWithType> transparency model, which is the transparency model that was used in the .NET Framework before the [!INCLUDE[net_v40_short](../../../includes/net-v40-short-md.md)].</span></span>  
  
 <span data-ttu-id="70bba-144">詳細については、<xref:System.Reflection.Emit.DynamicMethod> クラスを参照してください。</span><span class="sxs-lookup"><span data-stu-id="70bba-144">For more information, see the <xref:System.Reflection.Emit.DynamicMethod> class.</span></span>  
  
### <a name="generating-anonymously-hosted-dynamic-methods-from-partially-trusted-code"></a><span data-ttu-id="70bba-145">部分的に信頼されるコードによる匿名でホストされる動的メソッドの生成</span><span class="sxs-lookup"><span data-stu-id="70bba-145">Generating Anonymously Hosted Dynamic Methods from Partially Trusted Code</span></span>  
 <span data-ttu-id="70bba-146">インターネット アクセス許可が設定されたアセンブリで、匿名でホストされる動的メソッドを生成し、それを実行するための条件を考えてみましょう。</span><span class="sxs-lookup"><span data-stu-id="70bba-146">Consider the conditions in which an assembly with Internet permissions can generate an anonymously hosted dynamic method and execute it:</span></span>  
  
-   <span data-ttu-id="70bba-147">動的メソッドで使用されるのが、パブリックな型とメンバーのみである。</span><span class="sxs-lookup"><span data-stu-id="70bba-147">The dynamic method uses only public types and members.</span></span> <span data-ttu-id="70bba-148">許可セットに <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> が含まれる場合、許可セットが出力元アセンブリの許可セットと同じか、またはそのサブセットであるアセンブリの非パブリックの型とメンバーを使用できます。</span><span class="sxs-lookup"><span data-stu-id="70bba-148">If its grant set includes <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType>, it can use nonpublic types and members of any assembly whose grant set is equal to, or a subset of, the grant set of the emitting assembly.</span></span>  
  
-   <span data-ttu-id="70bba-149">動的メソッドで使用されるすべての型およびメンバーで必要なアクセス許可が、部分信頼のアセンブリの許可セットに含まれている。</span><span class="sxs-lookup"><span data-stu-id="70bba-149">The permissions that are required by all the types and members used by the dynamic method are included in the grant set of the partially trusted assembly.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="70bba-150">動的メソッドではデバッグ シンボルがサポートされていません。</span><span class="sxs-lookup"><span data-stu-id="70bba-150">Dynamic methods do not support debug symbols.</span></span>  
  
<a name="Dynamic_Methods_Associated_with_Existing_Assemblies"></a>   
## <a name="dynamic-methods-associated-with-existing-assemblies"></a><span data-ttu-id="70bba-151">既存のアセンブリに関連付けられている動的メソッド</span><span class="sxs-lookup"><span data-stu-id="70bba-151">Dynamic Methods Associated with Existing Assemblies</span></span>  
 <span data-ttu-id="70bba-152">動的メソッドに既存アセンブリの型またはモジュールを関連付けるには、関連付ける型またはモジュールを指定する <xref:System.Reflection.Emit.DynamicMethod> コンストラクターのどれかを使用します。</span><span class="sxs-lookup"><span data-stu-id="70bba-152">To associate a dynamic method with a type or module in an existing assembly, use any of the <xref:System.Reflection.Emit.DynamicMethod> constructors that specify the associated type or module.</span></span> <span data-ttu-id="70bba-153">動的メソッドに既存の型またはモジュールを関連付けると、動的メソッドが非パブリックの型とメンバーにアクセスできるようになるため、これらのコンストラクターを呼び出すにはアクセス許可が必要です。</span><span class="sxs-lookup"><span data-stu-id="70bba-153">The permissions that are required to call these constructors vary, because associating a dynamic method with an existing type or module gives the dynamic method access to nonpublic types and members:</span></span>  
  
-   <span data-ttu-id="70bba-154">型に関連付けられる動的メソッドは、その型のすべてのメンバー (プライベート メンバーを含む) にアクセスでき、関連付けられた型が含まれるアセンブリ内部のすべての型およびメンバーにアクセスできます。</span><span class="sxs-lookup"><span data-stu-id="70bba-154">A dynamic method that is associated with a type has access to all members of that type, even private members, and to all internal types and members in the assembly that contains the associated type.</span></span>  
  
-   <span data-ttu-id="70bba-155">モジュールに関連付けられる動的メソッドは、モジュールのすべての `internal` 型およびメンバー (Visual Basic では `Friend`、共通言語ランタイムのメタデータでは `assembly`) にアクセスできます。</span><span class="sxs-lookup"><span data-stu-id="70bba-155">A dynamic method that is associated with a module has access to all the `internal` types and members (`Friend` in Visual Basic, `assembly` in common language runtime metadata) in the module.</span></span>  
  
 <span data-ttu-id="70bba-156">さらに、JIT コンパイラの参照範囲チェックを省略する機能を指定するコンストラクターを使用できます。</span><span class="sxs-lookup"><span data-stu-id="70bba-156">In addition, you can use a constructor that specifies the ability to skip the visibility checks of the JIT compiler.</span></span> <span data-ttu-id="70bba-157">これを使用した場合、アクセス レベルに関係なく、動的メソッドからすべてのアセンブリのすべての型およびメンバーにアクセスできます。</span><span class="sxs-lookup"><span data-stu-id="70bba-157">Doing so gives your dynamic method access to all types and members in all assemblies, regardless of access level.</span></span>  
  
 <span data-ttu-id="70bba-158">コンストラクターで必要なアクセス許可は、動的メソッドに与えるアクセス許可のレベルに応じて決まります。</span><span class="sxs-lookup"><span data-stu-id="70bba-158">The permissions demanded by the constructor depend on how much access you decide to give your dynamic method:</span></span>  
  
-   <span data-ttu-id="70bba-159">メソッドでパブリックな型とメンバーのみを使用し、それに独自の型や独自のモジュールを関連付ける場合は、アクセス許可が不要です。</span><span class="sxs-lookup"><span data-stu-id="70bba-159">If your method uses only public types and members, and you associate it with your own type or your own module, no permissions are required.</span></span>  
  
-   <span data-ttu-id="70bba-160">JIT 参照範囲チェックを省略するように指定する場合、コンストラクターでは <xref:System.Security.Permissions.ReflectionPermission> に <xref:System.Security.Permissions.ReflectionPermissionFlag.MemberAccess?displayProperty=nameWithType> フラグを指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="70bba-160">If you specify that JIT visibility checks should be skipped, the constructor demands <xref:System.Security.Permissions.ReflectionPermission> with the <xref:System.Security.Permissions.ReflectionPermissionFlag.MemberAccess?displayProperty=nameWithType> flag.</span></span>  
  
-   <span data-ttu-id="70bba-161">動的メソッドに別の型を関連付ける場合 (独自に作成したアセンブリ内の別の型でも)、コンストラクターでは <xref:System.Security.Permissions.ReflectionPermission> に <xref:System.Security.Permissions.ReflectionPermissionFlag.MemberAccess?displayProperty=nameWithType> フラグを指定し、<xref:System.Security.Permissions.SecurityPermission> に <xref:System.Security.Permissions.SecurityPermissionFlag.ControlEvidence?displayProperty=nameWithType> フラグを指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="70bba-161">If you associate the dynamic method with another type, even another type in your own assembly, the constructor demands <xref:System.Security.Permissions.ReflectionPermission> with the <xref:System.Security.Permissions.ReflectionPermissionFlag.MemberAccess?displayProperty=nameWithType> flag and <xref:System.Security.Permissions.SecurityPermission> with the <xref:System.Security.Permissions.SecurityPermissionFlag.ControlEvidence?displayProperty=nameWithType> flag.</span></span>  
  
-   <span data-ttu-id="70bba-162">動的メソッドに別のアセンブリの型またはモジュールを関連付ける場合、コンストラクターでは 2 つの操作が必要です。それは、<xref:System.Security.Permissions.ReflectionPermission> に <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> フラグを指定することと、他方のモジュールを含むアセンブリの許可セットを用意することです。</span><span class="sxs-lookup"><span data-stu-id="70bba-162">If you associate the dynamic method with a type or module in another assembly, the constructor demands two things: <xref:System.Security.Permissions.ReflectionPermission> with the <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> flag, and the grant set of the assembly that contains the other module.</span></span> <span data-ttu-id="70bba-163">つまり、対象のモジュールの許可セットにあるすべてのアクセス許可に加えて、<xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> がコール スタックに含まれる必要があります。</span><span class="sxs-lookup"><span data-stu-id="70bba-163">That is, your call stack must include all the permissions in the grant set of the target module, plus <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType>.</span></span>  
  
    > [!NOTE]
    >  <span data-ttu-id="70bba-164">下位互換性を確保するために、対象の許可セットと <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> の両方の要件が満たされなかった場合、コンストラクターでは <xref:System.Security.Permissions.SecurityPermission> に <xref:System.Security.Permissions.SecurityPermissionFlag.ControlEvidence?displayProperty=nameWithType> フラグを指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="70bba-164">For backward compatibility, if the demand for the target grant set plus <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> fails, the constructor demands <xref:System.Security.Permissions.SecurityPermission> with the <xref:System.Security.Permissions.SecurityPermissionFlag.ControlEvidence?displayProperty=nameWithType> flag.</span></span>  
  
 <span data-ttu-id="70bba-165">この一覧の項目は出力アセンブリの許可セットの観点から書かれていますが、要求はコール スタック全体 (アプリケーション ドメイン境界を含む) に対してなされることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="70bba-165">Although the items in this list are described in terms of the grant set of the emitting assembly, remember that the demands are made against the full call stack, including the application domain boundary.</span></span>  
  
 <span data-ttu-id="70bba-166">詳細については、<xref:System.Reflection.Emit.DynamicMethod> クラスを参照してください。</span><span class="sxs-lookup"><span data-stu-id="70bba-166">For more information, see the <xref:System.Reflection.Emit.DynamicMethod> class.</span></span>  
  
### <a name="generating-dynamic-methods-from-partially-trusted-code"></a><span data-ttu-id="70bba-167">部分信頼コードからの動的メソッドの生成</span><span class="sxs-lookup"><span data-stu-id="70bba-167">Generating Dynamic Methods from Partially Trusted Code</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="70bba-168">部分的に信頼されるコードから動的メソッドを生成する方法として推奨されるのは、[匿名でホストされる動的メソッドを使用する方法](#Anonymously_Hosted_Dynamic_Methods)です。</span><span class="sxs-lookup"><span data-stu-id="70bba-168">The recommended way to generate dynamic methods from partially trusted code is to use [anonymously hosted dynamic methods](#Anonymously_Hosted_Dynamic_Methods).</span></span>  
  
 <span data-ttu-id="70bba-169">インターネット アクセス許可が設定されたアセンブリで、動的メソッドを生成し、それを実行するための条件を考えてみましょう。</span><span class="sxs-lookup"><span data-stu-id="70bba-169">Consider the conditions in which an assembly with Internet permissions can generate a dynamic method and execute it:</span></span>  
  
-   <span data-ttu-id="70bba-170">動的メソッドにそれを出力するモジュールまたは型が関連付けられているか、その許可セットに <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> が含まれている。さらに、関連付けられているモジュールが含まれているアセンブリの許可セットが出力アセンブリの許可セットと等しいか、そのサブセットである。</span><span class="sxs-lookup"><span data-stu-id="70bba-170">Either the dynamic method is associated with the module or type that emits it, or its grant set includes <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> and it is associated with a module in an assembly whose grant set is equal to, or a subset of, the grant set of the emitting assembly.</span></span>  
  
-   <span data-ttu-id="70bba-171">動的メソッドで使用されるのが、パブリックな型とメンバーのみである。</span><span class="sxs-lookup"><span data-stu-id="70bba-171">The dynamic method uses only public types and members.</span></span> <span data-ttu-id="70bba-172">許可セットに <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> が含まれ、関連付けられているモジュールが含まれているアセンブリの許可セットが出力アセンブリの許可セットと等しいか、そのサブセットである場合、その関連モジュールの中で `internal` と指定されている (Visual Basic では `Friend`、共通言語ランタイム メタデータでは `assembly`) 型とメンバーを使用できます。</span><span class="sxs-lookup"><span data-stu-id="70bba-172">If its grant set includes <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> and it is associated with a module in an assembly whose grant set is equal to, or a subset of, the grant set of the emitting assembly, it can use types and members marked `internal` (`Friend` in Visual Basic, `assembly` in common language runtime metadata) in the associated module.</span></span>  
  
-   <span data-ttu-id="70bba-173">動的メソッドで使用されるすべての型およびメンバーで必要なアクセス許可が、部分信頼のアセンブリの許可セットに含まれている。</span><span class="sxs-lookup"><span data-stu-id="70bba-173">The permissions demanded by all the types and members used by the dynamic method are included in the grant set of the partially trusted assembly.</span></span>  
  
-   <span data-ttu-id="70bba-174">動的メソッドで JIT 参照範囲チェックを省略しない。</span><span class="sxs-lookup"><span data-stu-id="70bba-174">The dynamic method does not skip JIT visibility checks.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="70bba-175">動的メソッドではデバッグ シンボルがサポートされていません。</span><span class="sxs-lookup"><span data-stu-id="70bba-175">Dynamic methods do not support debug symbols.</span></span>  
  
<a name="Version_Information"></a>   
## <a name="version-information"></a><span data-ttu-id="70bba-176">バージョン情報</span><span class="sxs-lookup"><span data-stu-id="70bba-176">Version Information</span></span>  
 <span data-ttu-id="70bba-177">[!INCLUDE[net_v40_short](../../../includes/net-v40-short-md.md)] 以降では、コンピューター全体のセキュリティ ポリシーが削除され、透過的セキュリティが既定の適用機構になりました。</span><span class="sxs-lookup"><span data-stu-id="70bba-177">Starting with the [!INCLUDE[net_v40_short](../../../includes/net-v40-short-md.md)], machine-wide security policy is eliminated and security transparency becomes the default enforcement mechanism.</span></span> <span data-ttu-id="70bba-178">「[セキュリティの変更](../../../docs/framework/security/security-changes.md)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="70bba-178">See [Security Changes](../../../docs/framework/security/security-changes.md).</span></span>  
  
 <span data-ttu-id="70bba-179">[!INCLUDE[net_v20SP1_long](../../../includes/net-v20sp1-long-md.md)] 以降では、動的アセンブリと動的メソッドを出力するときに、<xref:System.Security.Permissions.ReflectionPermission> に <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit?displayProperty=nameWithType> フラグを指定する必要がなくなりました。</span><span class="sxs-lookup"><span data-stu-id="70bba-179">Starting with the [!INCLUDE[net_v20SP1_long](../../../includes/net-v20sp1-long-md.md)], <xref:System.Security.Permissions.ReflectionPermission> with the <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit?displayProperty=nameWithType> flag is no longer required when emitting dynamic assemblies and dynamic methods.</span></span> <span data-ttu-id="70bba-180">このフラグは、それ以前のすべてのバージョンの [!INCLUDE[dnprdnshort](../../../includes/dnprdnshort-md.md)] では必要となります。</span><span class="sxs-lookup"><span data-stu-id="70bba-180">This flag is required in all earlier versions of the [!INCLUDE[dnprdnshort](../../../includes/dnprdnshort-md.md)].</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="70bba-181">`FullTrust` および `LocalIntranet` の名前付きアクセス許可セットでは、既定で <xref:System.Security.Permissions.ReflectionPermission> に <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit?displayProperty=nameWithType> フラグが指定されますが、`Internet` アクセス許可セットでは指定されません。</span><span class="sxs-lookup"><span data-stu-id="70bba-181"><xref:System.Security.Permissions.ReflectionPermission> with the <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit?displayProperty=nameWithType> flag is included by default in the `FullTrust` and `LocalIntranet` named permission sets, but not in the `Internet` permission set.</span></span> <span data-ttu-id="70bba-182">そのため、以前のバージョンの [!INCLUDE[dnprdnshort](../../../includes/dnprdnshort-md.md)] では、<xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit> に対して <xref:System.Security.PermissionSet.Assert%2A> を実行する場合にのみ、インターネット アクセス許可でライブラリを使用できます。</span><span class="sxs-lookup"><span data-stu-id="70bba-182">Therefore, in earlier versions of the [!INCLUDE[dnprdnshort](../../../includes/dnprdnshort-md.md)], a library can be used with Internet permissions only if it executes an <xref:System.Security.PermissionSet.Assert%2A> for <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit>.</span></span> <span data-ttu-id="70bba-183">このようなライブラリでは、コーディング エラーがあるとセキュリティ ホールが発生するおそれがあるため、セキュリティを慎重にレビューする必要があります。</span><span class="sxs-lookup"><span data-stu-id="70bba-183">Such libraries require careful security review because coding errors could result in security holes.</span></span> <span data-ttu-id="70bba-184">コードの生成は本質的に特権を必要とする操作ではないため、[!INCLUDE[net_v20SP1_short](../../../includes/net-v20sp1-short-md.md)] はセキュリティ確認要求を発行せずに部分信頼シナリオでコードを出力できます。</span><span class="sxs-lookup"><span data-stu-id="70bba-184">The [!INCLUDE[net_v20SP1_short](../../../includes/net-v20sp1-short-md.md)] allows code to be emitted in partial trust scenarios without issuing any security demands, because generating code is not inherently a privileged operation.</span></span> <span data-ttu-id="70bba-185">これは、生成されたコードには、コードを出力したアセンブリと同等以下のアクセス許可しかないことを意味します。</span><span class="sxs-lookup"><span data-stu-id="70bba-185">That is, the generated code has no more permissions than the assembly that emits it.</span></span> <span data-ttu-id="70bba-186">これにより、コードを出力するライブラリは透過的セキュリティになるため、<xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit> を要求する必要がなくなります。そのため、安全なライブラリを簡単に作成できるようになります。</span><span class="sxs-lookup"><span data-stu-id="70bba-186">This allows libraries that emit code to be security transparent and removes the need to assert <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit>, which simplifies the task of writing a secure library.</span></span>  
  
 <span data-ttu-id="70bba-187">さらに、[!INCLUDE[net_v20SP1_short](../../../includes/net-v20sp1-short-md.md)] では部分的に信頼される動的メソッドの非パブリックの型およびメンバーにアクセスできるように、<xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> フラグが導入されています。</span><span class="sxs-lookup"><span data-stu-id="70bba-187">In addition, the [!INCLUDE[net_v20SP1_short](../../../includes/net-v20sp1-short-md.md)] introduces the <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> flag for accessing nonpublic types and members from partially trusted dynamic methods.</span></span> <span data-ttu-id="70bba-188">以前のバージョンの [!INCLUDE[dnprdnshort](../../../includes/dnprdnshort-md.md)] では、動的メソッドで非パブリックの型およびメンバーにアクセスするには <xref:System.Security.Permissions.ReflectionPermissionFlag.MemberAccess?displayProperty=nameWithType> フラグが必要でした。これは、部分信頼のコードには付与されないアクセス許可です。</span><span class="sxs-lookup"><span data-stu-id="70bba-188">Earlier versions of the [!INCLUDE[dnprdnshort](../../../includes/dnprdnshort-md.md)] require the <xref:System.Security.Permissions.ReflectionPermissionFlag.MemberAccess?displayProperty=nameWithType> flag for dynamic methods that access nonpublic types and members; this is a permission that should never be granted to partially trusted code.</span></span>  
  
 <span data-ttu-id="70bba-189">最終的に、[!INCLUDE[net_v20SP1_short](../../../includes/net-v20sp1-short-md.md)] では、匿名でホストされるメソッドが導入されました。</span><span class="sxs-lookup"><span data-stu-id="70bba-189">Finally, the [!INCLUDE[net_v20SP1_short](../../../includes/net-v20sp1-short-md.md)] introduces anonymously hosted methods.</span></span>  
  
### <a name="obtaining-information-on-types-and-members"></a><span data-ttu-id="70bba-190">型およびメンバーの情報の取得</span><span class="sxs-lookup"><span data-stu-id="70bba-190">Obtaining Information on Types and Members</span></span>  
 <span data-ttu-id="70bba-191">[!INCLUDE[dnprdnlong](../../../includes/dnprdnlong-md.md)] 以降から、非パブリックな型とメンバーに関する情報を取得する際にアクセス許可は不要になりました。</span><span class="sxs-lookup"><span data-stu-id="70bba-191">Starting with the [!INCLUDE[dnprdnlong](../../../includes/dnprdnlong-md.md)], no permissions are required to obtain information about nonpublic types and members.</span></span> <span data-ttu-id="70bba-192">動的メソッドを出力するために必要な情報を取得するには、リフレクションを使用します。</span><span class="sxs-lookup"><span data-stu-id="70bba-192">Reflection is used to obtain information needed to emit dynamic methods.</span></span> <span data-ttu-id="70bba-193">たとえば、<xref:System.Reflection.MethodInfo> オブジェクトを使用してメソッド呼び出しを出力します。</span><span class="sxs-lookup"><span data-stu-id="70bba-193">For example, <xref:System.Reflection.MethodInfo> objects are used to emit method calls.</span></span> <span data-ttu-id="70bba-194">以前のバージョンの [!INCLUDE[dnprdnshort](../../../includes/dnprdnshort-md.md)] では、<xref:System.Security.Permissions.ReflectionPermission> に <xref:System.Security.Permissions.ReflectionPermissionFlag.TypeInformation?displayProperty=nameWithType> フラグを指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="70bba-194">Earlier versions of the [!INCLUDE[dnprdnshort](../../../includes/dnprdnshort-md.md)] require <xref:System.Security.Permissions.ReflectionPermission> with the <xref:System.Security.Permissions.ReflectionPermissionFlag.TypeInformation?displayProperty=nameWithType> flag.</span></span> <span data-ttu-id="70bba-195">詳しくは、「[リフレクションに関するセキュリティ上の考慮事項](../../../docs/framework/reflection-and-codedom/security-considerations-for-reflection.md)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="70bba-195">For more information, see [Security Considerations for Reflection](../../../docs/framework/reflection-and-codedom/security-considerations-for-reflection.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="70bba-196">参照</span><span class="sxs-lookup"><span data-stu-id="70bba-196">See Also</span></span>  
 [<span data-ttu-id="70bba-197">リフレクションに関するセキュリティ上の考慮事項</span><span class="sxs-lookup"><span data-stu-id="70bba-197">Security Considerations for Reflection</span></span>](../../../docs/framework/reflection-and-codedom/security-considerations-for-reflection.md)  
 [<span data-ttu-id="70bba-198">動的メソッドおよびアセンブリの出力</span><span class="sxs-lookup"><span data-stu-id="70bba-198">Emitting Dynamic Methods and Assemblies</span></span>](../../../docs/framework/reflection-and-codedom/emitting-dynamic-methods-and-assemblies.md)
