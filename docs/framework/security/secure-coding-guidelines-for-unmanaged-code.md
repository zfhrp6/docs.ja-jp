---
title: アンマネージ コードの安全なコーディングのガイドライン
ms.date: 03/30/2017
helpviewer_keywords:
- code security, unmanaged code
- unmanaged code, securing
- security [.NET Framework], unmanaged code
- secure coding, unmanaged code
ms.assetid: a8d15139-d368-4c9c-a747-ba757781117c
author: mairaw
ms.author: mairaw
ms.openlocfilehash: 60e293ac8c9100876aa5a524bb5dda04e9f4183f
ms.sourcegitcommit: 3d5d33f384eeba41b2dff79d096f47ccc8d8f03d
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 05/04/2018
ms.locfileid: "33408152"
---
# <a name="secure-coding-guidelines-for-unmanaged-code"></a>アンマネージ コードの安全なコーディングのガイドライン
一部のライブラリ コードは、アンマネージ コードを呼び出す必要があります (たとえば、Win32 などのネイティブ コード API)。 これは、マネージ コード用のセキュリティの境界の外部に出ることなので、注意が必要です。 セキュリティ的に中立なコードである場合、コードとそのコードを呼び出すコードは、アンマネージ コードのアクセス許可 (<xref:System.Security.Permissions.SecurityPermission> フラグを指定した <xref:System.Security.Permissions.SecurityPermissionFlag.UnmanagedCode> ) を持つ必要があります。  
  
 しかし、呼び出し元がこのような強力なアクセス許可を持つことが不適切な場合もあります。 このようなケースでは、信頼されるコードが、「 [ラッパー コードの保護](../../../docs/framework/misc/securing-wrapper-code.md)」で説明したマネージ ラッパーまたはライブラリ コードのように、仲介役になってしまう可能性があります。 基になるアンマネージ コードの機能が総合的に安全な場合は、それを直接公開できます。それ以外の場合は、最初に適切なアクセス許可のチェック (確認要求: demand) が必要です。  
  
 コードがアンマネージ コードを呼び出すとき、呼び出し元にアンマネージ コードへのアクセス許可を与えたくない場合は、その権限をアサートする必要があります。 アサーションは、フレーム内でのスタック ウォークをブロックします。 このプロセスで、セキュリティ ホールを作らないように注意が必要です。 通常、これは、呼び出し元の適切なアクセス許可を確認要求し、アンマネージ コードを使用して、アクセス許可で認められていることだけを実行し、それ以上のことは実行しないことを意味します。 日付関数の時刻の取得など、いくつかのケースでは、セキュリティ チェックを一切行わずにアンマネージ コードを呼び出し元に直接公開することがあります。 どのようなケースでも、アサートを行うコードはセキュリティ対策を実施することが必要です。  
  
 ネイティブ コードへのコード パスを提供するどのようなマネージ コードも、悪意のあるコードのターゲットになる可能性があります。このため、安全に使用できるアンマネージ コードやその使用方法を決めるには、十分な注意が必要です。 一般に、どのアンマネージ コードも、部分的な信頼の呼び出し元に直接公開するべきではありません。 部分的な信頼のコードから呼び出せるアンマネージ コードをライブラリで使用することの安全性を評価するには、主に次の 2 つの点について考慮する必要があります。  
  
-   **機能**。 呼び出し元が危険性のある操作を実行できないようにする機能がアンマネージ API によって提供されているかどうかを考慮します。 コード アクセス セキュリティはアクセス許可を使用してリソースへのアクセスを強制するため、API がファイル、ユーザー インターフェイス、またはスレッドを使用するかどうか、あるいは、保護されている情報を公開するかどうかを考慮します。 API がこれを行うときは、それをラップするマネージ コードが、実行前に必要なアクセス許可を確認要求する必要があります。 また、アクセス許可で保護されていない場合は、メモリへのアクセスを厳密なタイプ セーフに制限する必要があります。  
  
-   **パラメーターのチェック**。 一般的な攻撃は、公開されているアンマネージ コードの API メソッドに予期しないパラメーターを渡し、仕様とは異なる動作をさせようと試みます。 範囲外のインデックス値やオフセット値を使用するバッファー オーバーラン攻撃は、この種の攻撃の一例であり、パラメーターの基のコードのバグを攻略します。 このため、アンマネージ コード API が部分的な信頼の呼び出し元に対して安全に機能している場合でも (必要な確認要求の後)、マネージ コードもパラメーターの正当性を二重にチェックし、悪意のあるコードが、マネージ コードのラッパー レイヤーを使用して予期しない呼び出しを行うのを不可能にすることが必要です。  
  
## <a name="using-suppressunmanagedcodesecurityattribute"></a>SuppressUnmanagedCodeSecurityAttribute の使用  
 アサートの後でアンマネージ コードを呼び出すのは、パフォーマンスの面で問題があります。 このような呼び出しのたびに、セキュリティ システムはアンマネージ コードのアクセス許可を自動的に確認要求し、結果として毎回スタック ウォークが発生します。 アサート直後にアンマネージ コードを呼び出すと、スタック ウォークは意味がなくなります。それは、アサートとアンマネージ コードの呼び出しで構成されるからです。  
  
 <xref:System.Security.SuppressUnmanagedCodeSecurityAttribute> というカスタム属性をアンマネージ コードのエントリ ポイントに適用して、 <xref:System.Security.Permissions.SecurityPermission> アクセス許可を指定した <xref:System.Security.Permissions.SecurityPermissionFlag.UnmanagedCode> を確認要求する通常のセキュリティ チェックを無効にできます。 このアクションは、実行時のセキュリティ チェックがない状態で、アンマネージ コードに通じるドアを開くことになるため、これを実行するときは大きな注意が必要です。 **SuppressUnmanagedCodeSecurityAttribute** を適用した場合でも、Just-In-Time (JIT) コンパイル時に 1 回だけセキュリティ チェックが発生し、直前の呼び出し元がアンマネージ コードを呼び出すアクセス許可を持っていることを確認します。  
  
 **SuppressUnmanagedCodeSecurityAttribute**を使用する場合は、次の点をチェックしてください。  
  
-   アンマネージ コードのエントリ ポイントを内部にするか、またはコード外からはアクセスできないようにします。  
  
-   アンマネージ コードを呼び出すと、セキュリティ ホールになる可能性があります。 悪意のあるコードが間接的にアンマネージ コードを呼び出し、セキュリティ チェックを回避するポータルとして、自分のコードが使用されていないことを確認します。 必要な場合は、アクセス許可を確認要求します。  
  
-   以下のセクションで説明されているように、アンマネージ コードへの危険なパスを作成するときは、名前付け規則を使用して明示的に識別します。  
  
## <a name="naming-convention-for-unmanaged-code-methods"></a>アンマネージ コード メソッド用の名前付け規則  
 有用な名前付け規則がアンマネージ コード メソッド用に確立されているので、使用されることを強くお勧めします。 すべてのアンマネージ コード メソッドは、 **safe**、 **native**、 **unsafe**の 3 つのカテゴリに分類されます。 これらのキーワードは、内部にさまざまな種類のアンマネージ コード エントリ ポイントを定義するクラス名として使用できます。 ソース コードでは、これらのキーワードをクラス名に追加する必要があります。たとえば、 `Safe.GetTimeOfDay`、 `Native.Xyz`、または `Unsafe.DangerousAPI`のように表記します。 次の表に示すように、各キーワードはそのクラスを使用する開発者に有用なセキュリティ情報を提供します。  
  
|キーワード|セキュリティの考慮事項|  
|-------------|-----------------------------|  
|**safe**|任意のコードにとって (悪意のあるコードにも)、呼び出すことがまったく安全です。 他のマネージ コードと同じように使用できます。 たとえば、1 日の時刻を取得する関数は典型的に安全です。|  
|**native**|セキュリティに中立的。つまり、呼び出すためにアンマネージ コードのアクセス許可を必要とするアンマネージ コードです。 セキュリティがチェックされ、承認のない呼び出し元は停止されます。|  
|**unsafe**|セキュリティが抑止された、危険性のあるアンマネージ コード エントリ ポイントです。 このようなアンマネージ コードを使用するとき、開発者は最大限の注意を払う必要があり、セキュリティ脆弱性を避けるための別の手段の保護機能が設定されていることを確認します。 このキーワードはセキュリティ システムをオーバーライドするため、開発者がセキュリティ対策を行う必要があります。|  
  
## <a name="see-also"></a>関連項目  
 [安全なコーディングのガイドライン](../../../docs/standard/security/secure-coding-guidelines.md)
