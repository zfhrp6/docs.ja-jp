---
title: '方法: スレッド ローカル変数を使用する Parallel.ForEach ループを記述する'
ms.date: 03/30/2017
ms.technology: dotnet-standard
dev_langs:
- csharp
- vb
helpviewer_keywords:
- parallel foreach loop, how to use local state
ms.assetid: 24b10041-b30b-45cb-aa65-66cf568ca76d
author: rpetrusha
ms.author: ronpet
ms.openlocfilehash: 4a89b3f25fb3d6e85c666e57f24e68c297c8c29a
ms.sourcegitcommit: 3d5d33f384eeba41b2dff79d096f47ccc8d8f03d
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 05/04/2018
ms.locfileid: "33582738"
---
# <a name="how-to-write-a-parallelforeach-loop-with-thread-local-variables"></a><span data-ttu-id="bffe8-102">方法: スレッド ローカル変数を使用する Parallel.ForEach ループを記述する</span><span class="sxs-lookup"><span data-stu-id="bffe8-102">How to: Write a Parallel.ForEach Loop with Thread-Local Variables</span></span>
<span data-ttu-id="bffe8-103">スレッド ローカル変数を持つ <xref:System.Threading.Tasks.Parallel.ForEach%2A> メソッドを記述する方法を次の例に示します。</span><span class="sxs-lookup"><span data-stu-id="bffe8-103">The following example shows how to write a <xref:System.Threading.Tasks.Parallel.ForEach%2A> method that uses thread-local variables.</span></span> <span data-ttu-id="bffe8-104"><xref:System.Threading.Tasks.Parallel.ForEach%2A> ループが実行されると、そのソース コレクションが複数のパーティションに分割されます。</span><span class="sxs-lookup"><span data-stu-id="bffe8-104">When a <xref:System.Threading.Tasks.Parallel.ForEach%2A> loop executes, it divides its source collection into multiple partitions.</span></span> <span data-ttu-id="bffe8-105">各パーティションには、"スレッド ローカル" 変数が個別にコピーされます </span><span class="sxs-lookup"><span data-stu-id="bffe8-105">Each partition will get its own copy of the "thread-local" variable.</span></span> <span data-ttu-id="bffe8-106">("スレッド ローカル" という用語は少し不正確です。1 つのスレッド上で 2 つのパーティションが実行されることがあるからです)。</span><span class="sxs-lookup"><span data-stu-id="bffe8-106">(The term "thread-local" is slightly inaccurate here, because in some cases two partitions may run on the same thread.)</span></span>  
  
 <span data-ttu-id="bffe8-107">この例のコードおよびパラメーターは、対応する <xref:System.Threading.Tasks.Parallel.For%2A> メソッドによく似ています。</span><span class="sxs-lookup"><span data-stu-id="bffe8-107">The code and parameters in this example closely resemble the corresponding <xref:System.Threading.Tasks.Parallel.For%2A> method.</span></span> <span data-ttu-id="bffe8-108">詳細については、「[方法: スレッド ローカル変数を使用する Parallel.For ループを記述する](../../../docs/standard/parallel-programming/how-to-write-a-parallel-for-loop-with-thread-local-variables.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="bffe8-108">For more information, see [How to: Write a Parallel.For Loop with Thread-Local Variables](../../../docs/standard/parallel-programming/how-to-write-a-parallel-for-loop-with-thread-local-variables.md).</span></span>  
  
 <span data-ttu-id="bffe8-109"><xref:System.Threading.Tasks.Parallel.ForEach%2A> ループでスレッド ローカル変数を使用するには、2 つのタイプのパラメーターを取るメソッド オーバーロードのうち、いずれか 1 つを呼び出す必要があります。</span><span class="sxs-lookup"><span data-stu-id="bffe8-109">To use a thread-local variable in a <xref:System.Threading.Tasks.Parallel.ForEach%2A> loop, you must call one of the method overloads that takes two type parameters.</span></span> <span data-ttu-id="bffe8-110">最初の型パラメーター `TSource` でソース要素の型を指定し、2 番目の型パラメーター `TLocal` でスレッド ローカル変数の型を指定します。</span><span class="sxs-lookup"><span data-stu-id="bffe8-110">The first type parameter, `TSource`, specifies the type of the source element, and the second type parameter, `TLocal`, specifies the type of the thread-local variable.</span></span>  
  
## <a name="example"></a><span data-ttu-id="bffe8-111">例</span><span class="sxs-lookup"><span data-stu-id="bffe8-111">Example</span></span>  
 <span data-ttu-id="bffe8-112">以下の例では、<xref:System.Threading.Tasks.Parallel.ForEach%60%602%28System.Collections.Generic.IEnumerable%7B%60%600%7D%2CSystem.Func%7B%60%601%7D%2CSystem.Func%7B%60%600%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%601%2C%60%601%7D%2CSystem.Action%7B%60%601%7D%29?displayProperty=nameWithType> のオーバーロードを呼び出して、100 万個の要素からなる配列の合計を計算します。</span><span class="sxs-lookup"><span data-stu-id="bffe8-112">The following example calls <xref:System.Threading.Tasks.Parallel.ForEach%60%602%28System.Collections.Generic.IEnumerable%7B%60%600%7D%2CSystem.Func%7B%60%601%7D%2CSystem.Func%7B%60%600%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%601%2C%60%601%7D%2CSystem.Action%7B%60%601%7D%29?displayProperty=nameWithType> overload to compute the sum of an array of one million elements.</span></span> <span data-ttu-id="bffe8-113">このオーバーロードには、4 つのパラメータがあります。</span><span class="sxs-lookup"><span data-stu-id="bffe8-113">This overload has four parameters:</span></span>  
  
-   <span data-ttu-id="bffe8-114">`source`。データ ソースです。</span><span class="sxs-lookup"><span data-stu-id="bffe8-114">`source`, which is the data source.</span></span> <span data-ttu-id="bffe8-115">これは、<xref:System.Collections.Generic.IEnumerable%601> を実装する必要があります。</span><span class="sxs-lookup"><span data-stu-id="bffe8-115">It must implement <xref:System.Collections.Generic.IEnumerable%601>.</span></span> <span data-ttu-id="bffe8-116">この例のデータ ソースは、`IEnumerable<Int32>` によって返される、100 万個のメンバーからなる <xref:System.Linq.Enumerable.Range%2A?displayProperty=nameWithType> オブジェクトです。</span><span class="sxs-lookup"><span data-stu-id="bffe8-116">The data source in our example is the one million member `IEnumerable<Int32>` object returned by the <xref:System.Linq.Enumerable.Range%2A?displayProperty=nameWithType> method.</span></span>  
  
-   <span data-ttu-id="bffe8-117">`localInit`。またはスレッド ローカル変数を初期化する関数です。</span><span class="sxs-lookup"><span data-stu-id="bffe8-117">`localInit`, or the function that initializes the thread-local variable.</span></span> <span data-ttu-id="bffe8-118">この関数は、<xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> 操作が実行される各パーティションで 1 回呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="bffe8-118">This function is called once for each partition in which the <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> operation executes.</span></span> <span data-ttu-id="bffe8-119">この例では、スレッド ローカル変数がゼロに初期化されます。</span><span class="sxs-lookup"><span data-stu-id="bffe8-119">Our example initializes the thread-local variable to zero.</span></span>  
  
-   <span data-ttu-id="bffe8-120">`body`。ループの各反復処理に対して並列ループで呼び出される <xref:System.Func%604> です。</span><span class="sxs-lookup"><span data-stu-id="bffe8-120">`body`, a <xref:System.Func%604> that is invoked by the parallel loop on each iteration of the loop.</span></span> <span data-ttu-id="bffe8-121">シグニチャは `Func\<TSource, ParallelLoopState, TLocal, TLocal>` です。</span><span class="sxs-lookup"><span data-stu-id="bffe8-121">Its signature is `Func\<TSource, ParallelLoopState, TLocal, TLocal>`.</span></span> <span data-ttu-id="bffe8-122">プログラマはデリゲートのコードを作成します。入力パラメーターはループから渡されます。これらの入力パラメーターは以下のとおりです。</span><span class="sxs-lookup"><span data-stu-id="bffe8-122">You supply the code for the delegate, and the loop passes in the input parameters, which are:</span></span>  
  
    -   <span data-ttu-id="bffe8-123"><xref:System.Collections.Generic.IEnumerable%601> の現在の要素。</span><span class="sxs-lookup"><span data-stu-id="bffe8-123">The current element of the <xref:System.Collections.Generic.IEnumerable%601>.</span></span>  
  
    -   <span data-ttu-id="bffe8-124"><xref:System.Threading.Tasks.ParallelLoopState> 変数。デリゲートのコードで、ループの状態を確認するために使用できます。</span><span class="sxs-lookup"><span data-stu-id="bffe8-124">A <xref:System.Threading.Tasks.ParallelLoopState> variable that you can use in your delegate's code to examine the state of the loop.</span></span>  
  
    -   <span data-ttu-id="bffe8-125">スレッド ローカル変数。</span><span class="sxs-lookup"><span data-stu-id="bffe8-125">The thread-local variable.</span></span>  
  
     <span data-ttu-id="bffe8-126">デリゲートからスレッド ローカル変数が返されると、その変数は、その特定のパーティションで実行されるループの次の反復処理に渡されます。</span><span class="sxs-lookup"><span data-stu-id="bffe8-126">Your delegate returns the thread-local variable, which is then passed to the next iteration of the loop that executes in that particular partition.</span></span> <span data-ttu-id="bffe8-127">ループ パーティションごとに、この変数の個別のインスタンスが保持されます。</span><span class="sxs-lookup"><span data-stu-id="bffe8-127">Each loop partition maintains a separate instance of this variable.</span></span>  
  
     <span data-ttu-id="bffe8-128">この例では、デリゲートによって個々の整数の値がスレッド ローカル変数に追加されます。スレッド ローカル変数には、そのパーティションで順次追加される整数要素の値の現在の合計が保持されます。</span><span class="sxs-lookup"><span data-stu-id="bffe8-128">In the example, the delegate adds the value of each integer to the thread-local variable, which maintains a running total of the values of the integer elements in that partition.</span></span>  
  
-   <span data-ttu-id="bffe8-129">`localFinally`。各パーティションでのループ操作が完了した時点で、`Action<TLocal>` によって呼び出される <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> デリゲート。</span><span class="sxs-lookup"><span data-stu-id="bffe8-129">`localFinally`, an `Action<TLocal>` delegate that the <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> invokes when the looping operations in each partition have completed.</span></span> <span data-ttu-id="bffe8-130"><xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> メソッドは、`Action<TLocal>` デリゲートに、このスレッド (ループ パーティション) のスレッド ローカル変数の最終値を返します。プログラマは、このパーティションの結果と他のパーティションの結果を結合するために必要な操作を実行するコードを作成します。</span><span class="sxs-lookup"><span data-stu-id="bffe8-130">The <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> method passes your `Action<TLocal>` delegate the final value of the thread-local variable for this thread (or loop partition), and you provide the code that performs the required action for combining the result from this partition with the results from the other partitions.</span></span> <span data-ttu-id="bffe8-131">このデリゲートは、複数のタスクで同時に呼び出すことができます。</span><span class="sxs-lookup"><span data-stu-id="bffe8-131">This delegate can be invoked concurrently by multiple tasks.</span></span> <span data-ttu-id="bffe8-132">このため、この例では <xref:System.Threading.Interlocked.Add%28System.Int32%40%2CSystem.Int32%29?displayProperty=nameWithType> 変数へのアクセスを同期するために `total` メソッドが使用されます。</span><span class="sxs-lookup"><span data-stu-id="bffe8-132">Because of this, the example uses the <xref:System.Threading.Interlocked.Add%28System.Int32%40%2CSystem.Int32%29?displayProperty=nameWithType> method to synchronize access to the `total` variable.</span></span> <span data-ttu-id="bffe8-133">デリゲート型は <xref:System.Action%601> であるため、戻り値はありません。</span><span class="sxs-lookup"><span data-stu-id="bffe8-133">Because the delegate type is an <xref:System.Action%601>, there is no return value.</span></span>  
  
 [!code-csharp[TPL_Parallel#04](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_parallel/cs/foreachthreadlocal.cs#04)]
 [!code-vb[TPL_Parallel#04](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_parallel/vb/foreachthreadlocal.vb#04)]  
  
## <a name="see-also"></a><span data-ttu-id="bffe8-134">参照</span><span class="sxs-lookup"><span data-stu-id="bffe8-134">See Also</span></span>  
 [<span data-ttu-id="bffe8-135">データの並列化</span><span class="sxs-lookup"><span data-stu-id="bffe8-135">Data Parallelism</span></span>](../../../docs/standard/parallel-programming/data-parallelism-task-parallel-library.md)  
 [<span data-ttu-id="bffe8-136">方法: スレッド ローカル変数を使用する Parallel.For ループを記述する</span><span class="sxs-lookup"><span data-stu-id="bffe8-136">How to: Write a Parallel.For Loop with Thread-Local Variables</span></span>](../../../docs/standard/parallel-programming/how-to-write-a-parallel-for-loop-with-thread-local-variables.md)  
 [<span data-ttu-id="bffe8-137">PLINQ および TPL のラムダ式</span><span class="sxs-lookup"><span data-stu-id="bffe8-137">Lambda Expressions in PLINQ and TPL</span></span>](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md)
